[gd_scene load_steps=11 format=2]

[ext_resource path="res://worlds/player.gd" type="Script" id=1]
[ext_resource path="res://default.tres" type="Theme" id=2]

[sub_resource type="GDScript" id=2]
resource_name = "HUD"
script/source = "extends MarginContainer

var ability_timer: Timer = null

# -- Signal Method --
func _consumable_value_changed(val): 
	$Desktop/HB/ConsumePanel/ValueLabel.text = str(val)
	$Mobile/Control/ConsumePanel/Label.text = str(val)

func _health_base_changed(): $TopNav/HealthBar.max_value = Player.health_base

func _dash_charge_changed(): 
	$Mobile/Control/DashPanel/ValueLabel.text = str(Player.dash_charge)
	$Desktop/HB/DashPanel/ValueLabel.text = str(Player.dash_charge)

func _health_changed():
	$TopNav/HealthBar/Label.text = str(Player.health)
	$TopNav/HealthBar.value = Player.health

func _bag_button_pressed(): Player.get_panel(\"Bag\").init()

func _ready():
	Player.connect(\"consumable_value_changed\", self, \"_consumable_value_changed\")
	Player.connect(\"health_base_changed\", self, \"_health_base_changed\")
	Player.connect(\"health_changed\", self, \"_health_changed\")
	Player.connect(\"dash_charge_changed\", self, \"_dash_charge_changed\")
	$TopNav/BagButton.connect(\"pressed\", self, \"_bag_button_pressed\")

func _physics_process(_delta):
	if ability_timer: 
		$Desktop/HB/AbilityPanel/CooldownLabel.text = str(stepify(ability_timer.time_left, 0.1))
		$Mobile/Control/AbilityPanel/Label.text = str(stepify(ability_timer.time_left, 0.1))
	
	if Player.dash_charge_base:
		$Mobile/Control/DashPanel/CooldownLabel.text = str(stepify(Player.dash_cooldown.time_left, 0.1))
		$Desktop/HB/DashPanel/CooldownLabel.text = str(stepify(Player.dash_cooldown.time_left, 0.1))

func set_ability_timer(timer): ability_timer = timer
"

[sub_resource type="GDScript" id=3]
resource_name = "EquipmentButton"
script/source = "extends VBoxContainer

var selected: String = \"\"

# -- Signal Method --
func _center_button_down():
	for child in $HB.get_children():
		if Player.equipped[child.name.to_lower()]:
			child.get_node(\"Label\").text = str(Player.equipped[child.name.to_lower()])
		child.show()

func _center_button_up():
	if selected:
		Player.get_panel(\"Equipment\").init(selected)
		selected = \"\"
	for child in $HB.get_children(): child.hide()

# -- Main --
func _ready():
	for child in $HB.get_children(): child.hide()
	$Center.connect(\"button_down\", self, \"_center_button_down\")
	$Center.connect(\"button_up\", self, \"_center_button_up\")

func _input(event):
	if event is InputEventScreenDrag:
		selected = \"\"
		for child in $HB.get_children():
			if child.get_node(\"TSB\").is_pressed():
				selected = child.name.to_lower()

"

[sub_resource type="RectangleShape2D" id=5]
extents = Vector2( 32, 32 )

[sub_resource type="GDScript" id=15]
resource_name = "Mobile"
script/source = "extends MarginContainer

var velocity: Vector2
var analog_index

func _ready():
	self.visible = Player.android_mode

func _input(event):
	if $Analog.pressed:
		if event is InputEventScreenDrag:
			velocity = ((event.position - $Analog.rect_global_position) - ($Analog.rect_min_size / 2)).normalized()
	else: velocity = Vector2()
"

[sub_resource type="RectangleShape2D" id=12]
extents = Vector2( 96, 96 )

[sub_resource type="RectangleShape2D" id=13]
extents = Vector2( 24, 24 )

[sub_resource type="RectangleShape2D" id=14]
extents = Vector2( 48, 48 )

[sub_resource type="GDScript" id=16]
resource_name = "Desktop"
script/source = "extends MarginContainer

func _ready():
	self.visible = !Player.android_mode
"

[node name="Player" type="CanvasLayer"]
script = ExtResource( 1 )

[node name="HUD" type="MarginContainer" parent="."]
anchor_right = 1.0
anchor_bottom = 1.0
mouse_filter = 1
theme = ExtResource( 2 )
custom_constants/margin_right = 24
custom_constants/margin_top = 24
custom_constants/margin_left = 24
custom_constants/margin_bottom = 24
script = SubResource( 2 )

[node name="TopNav" type="Control" parent="HUD"]
margin_left = 24.0
margin_top = 24.0
margin_right = 1256.0
margin_bottom = 696.0
mouse_filter = 1

[node name="HealthBar" type="ProgressBar" parent="HUD/TopNav"]
margin_right = 4.0
margin_bottom = 14.0
rect_min_size = Vector2( 320, 32 )
mouse_filter = 1
percent_visible = false

[node name="Label" type="Label" parent="HUD/TopNav/HealthBar"]
anchor_right = 1.0
anchor_bottom = 1.0
mouse_filter = 1
align = 1
valign = 1

[node name="MenuButton" type="Button" parent="HUD/TopNav"]
anchor_left = 0.5
anchor_right = 0.5
margin_left = -6.0
margin_right = 6.0
margin_bottom = 20.0
rect_min_size = Vector2( 64, 64 )
focus_mode = 0
mouse_filter = 1
text = "Menu"

[node name="EquipmentButton" type="VBoxContainer" parent="HUD/TopNav"]
anchor_left = 1.0
anchor_right = 1.0
margin_left = -200.0
margin_bottom = 132.0
script = SubResource( 3 )

[node name="Center" type="Button" parent="HUD/TopNav/EquipmentButton"]
margin_left = 68.0
margin_right = 132.0
margin_bottom = 64.0
rect_min_size = Vector2( 64, 64 )
focus_mode = 0
mouse_filter = 1
size_flags_horizontal = 4
size_flags_vertical = 0
keep_pressed_outside = true
text = "Eqs"

[node name="HB" type="HBoxContainer" parent="HUD/TopNav/EquipmentButton"]
margin_top = 68.0
margin_right = 200.0
margin_bottom = 132.0

[node name="Claw" type="Panel" parent="HUD/TopNav/EquipmentButton/HB"]
margin_right = 64.0
margin_bottom = 64.0
rect_min_size = Vector2( 64, 64 )
mouse_filter = 2

[node name="Label" type="Label" parent="HUD/TopNav/EquipmentButton/HB/Claw"]
margin_left = 7.0
margin_top = 17.0
margin_right = 41.0
margin_bottom = 31.0
mouse_filter = 1
align = 1
valign = 1

[node name="TSB" type="TouchScreenButton" parent="HUD/TopNav/EquipmentButton/HB/Claw"]
shape = SubResource( 5 )
passby_press = true

[node name="Ability" type="Panel" parent="HUD/TopNav/EquipmentButton/HB"]
margin_left = 68.0
margin_right = 132.0
margin_bottom = 64.0
rect_min_size = Vector2( 64, 64 )
mouse_filter = 2

[node name="Label" type="Label" parent="HUD/TopNav/EquipmentButton/HB/Ability"]
anchor_right = 1.0
anchor_bottom = 1.0
mouse_filter = 1
align = 1
valign = 1

[node name="TSB" type="TouchScreenButton" parent="HUD/TopNav/EquipmentButton/HB/Ability"]
shape = SubResource( 5 )
passby_press = true

[node name="Consumable" type="Panel" parent="HUD/TopNav/EquipmentButton/HB"]
margin_left = 136.0
margin_right = 200.0
margin_bottom = 64.0
rect_min_size = Vector2( 64, 64 )
mouse_filter = 2

[node name="Label" type="Label" parent="HUD/TopNav/EquipmentButton/HB/Consumable"]
anchor_right = 1.0
anchor_bottom = 1.0
mouse_filter = 1
align = 1
valign = 1

[node name="TSB" type="TouchScreenButton" parent="HUD/TopNav/EquipmentButton/HB/Consumable"]
shape = SubResource( 5 )
passby_press = true

[node name="BagButton" type="Button" parent="HUD/TopNav"]
anchor_left = 1.0
anchor_right = 1.0
margin_left = -64.0
margin_bottom = 64.0
rect_min_size = Vector2( 64, 64 )
focus_mode = 0
mouse_filter = 1
text = "Bag"

[node name="Mobile" type="MarginContainer" parent="HUD"]
visible = false
modulate = Color( 1, 1, 1, 0.607843 )
margin_left = 24.0
margin_top = 24.0
margin_right = 1256.0
margin_bottom = 696.0
mouse_filter = 2
custom_constants/margin_right = 100
custom_constants/margin_top = 50
custom_constants/margin_left = 100
custom_constants/margin_bottom = 50
script = SubResource( 15 )

[node name="Analog" type="Button" parent="HUD/Mobile"]
margin_left = 100.0
margin_top = 422.0
margin_right = 300.0
margin_bottom = 622.0
rect_min_size = Vector2( 200, 200 )
focus_mode = 0
mouse_filter = 1
size_flags_horizontal = 0
size_flags_vertical = 8
action_mode = 0
enabled_focus_mode = 0
keep_pressed_outside = true

[node name="Control" type="Control" parent="HUD/Mobile"]
margin_left = 788.0
margin_top = 330.0
margin_right = 1132.0
margin_bottom = 622.0
rect_min_size = Vector2( 344, 292 )
mouse_filter = 2
size_flags_horizontal = 8
size_flags_vertical = 8

[node name="AttackPanel" type="Panel" parent="HUD/Mobile/Control"]
anchor_left = 0.5
anchor_top = 1.0
anchor_right = 0.5
anchor_bottom = 1.0
margin_left = -72.0
margin_top = -192.0
margin_right = 120.0
rect_min_size = Vector2( 192, 192 )
mouse_filter = 1
__meta__ = {
"_edit_use_anchors_": true
}

[node name="TSB" type="TouchScreenButton" parent="HUD/Mobile/Control/AttackPanel"]
shape = SubResource( 12 )
action = "n_attack"

[node name="ConsumePanel" type="Panel" parent="HUD/Mobile/Control"]
anchor_left = 1.0
anchor_top = 1.0
anchor_right = 1.0
anchor_bottom = 1.0
margin_left = -48.0
margin_top = -112.0
margin_bottom = -64.0
rect_min_size = Vector2( 48, 48 )
mouse_filter = 1
__meta__ = {
"_edit_use_anchors_": true
}

[node name="TSB" type="TouchScreenButton" parent="HUD/Mobile/Control/ConsumePanel"]
shape = SubResource( 13 )
action = "n_consume"

[node name="Label" type="Label" parent="HUD/Mobile/Control/ConsumePanel"]
anchor_right = 1.0
anchor_bottom = 1.0
text = "0"
align = 1
valign = 1

[node name="AbilityPanel" type="Panel" parent="HUD/Mobile/Control"]
anchor_left = 0.5
anchor_right = 0.5
margin_left = -72.0
margin_right = 24.0001
margin_bottom = 96.0
rect_min_size = Vector2( 64, 64 )
mouse_filter = 1
__meta__ = {
"_edit_use_anchors_": true
}

[node name="TSB" type="TouchScreenButton" parent="HUD/Mobile/Control/AbilityPanel"]
shape = SubResource( 14 )
action = "n_ability"

[node name="Label" type="Label" parent="HUD/Mobile/Control/AbilityPanel"]
anchor_right = 1.0
anchor_bottom = 1.0
text = "0"
align = 1
valign = 1

[node name="DashPanel" type="Panel" parent="HUD/Mobile/Control"]
anchor_top = 0.5
anchor_bottom = 0.5
margin_top = -46.0
margin_right = 96.0
margin_bottom = 50.0
rect_min_size = Vector2( 96, 96 )
mouse_filter = 1
__meta__ = {
"_edit_use_anchors_": true
}

[node name="TSB" type="TouchScreenButton" parent="HUD/Mobile/Control/DashPanel"]
shape = SubResource( 14 )
action = "n_dash"

[node name="ValueLabel" type="Label" parent="HUD/Mobile/Control/DashPanel"]
anchor_right = 1.0
anchor_bottom = 1.0
text = "0"

[node name="CooldownLabel" type="Label" parent="HUD/Mobile/Control/DashPanel"]
anchor_right = 1.0
anchor_bottom = 1.0
text = "0"
align = 2
valign = 2

[node name="Desktop" type="MarginContainer" parent="HUD"]
margin_left = 24.0
margin_top = 24.0
margin_right = 1256.0
margin_bottom = 696.0
mouse_filter = 2
script = SubResource( 16 )

[node name="HB" type="HBoxContainer" parent="HUD/Desktop"]
margin_left = 936.0
margin_top = 576.0
margin_right = 1232.0
margin_bottom = 672.0
size_flags_horizontal = 8
size_flags_vertical = 8

[node name="DashPanel" type="Panel" parent="HUD/Desktop/HB"]
margin_right = 96.0
margin_bottom = 96.0
rect_min_size = Vector2( 96, 96 )

[node name="Label" type="Label" parent="HUD/Desktop/HB/DashPanel"]
anchor_right = 1.0
anchor_bottom = 1.0
text = "Dash"
align = 1
valign = 1

[node name="CooldownLabel" type="Label" parent="HUD/Desktop/HB/DashPanel"]
anchor_right = 1.0
anchor_bottom = 1.0
text = "0.0"
align = 2
valign = 2

[node name="ValueLabel" type="Label" parent="HUD/Desktop/HB/DashPanel"]
anchor_right = 1.0
anchor_bottom = 1.0
text = "0.0"

[node name="ConsumePanel" type="Panel" parent="HUD/Desktop/HB"]
margin_left = 100.0
margin_right = 196.0
margin_bottom = 96.0
rect_min_size = Vector2( 96, 96 )

[node name="Label" type="Label" parent="HUD/Desktop/HB/ConsumePanel"]
anchor_right = 1.0
anchor_bottom = 1.0
text = "Consume"
align = 1
valign = 1

[node name="ValueLabel" type="Label" parent="HUD/Desktop/HB/ConsumePanel"]
anchor_right = 1.0
anchor_bottom = 1.0
text = "0.0"

[node name="AbilityPanel" type="Panel" parent="HUD/Desktop/HB"]
margin_left = 200.0
margin_right = 296.0
margin_bottom = 96.0
rect_min_size = Vector2( 96, 96 )

[node name="Label" type="Label" parent="HUD/Desktop/HB/AbilityPanel"]
anchor_right = 1.0
anchor_bottom = 1.0
text = "Ability"
align = 1
valign = 1

[node name="CooldownLabel" type="Label" parent="HUD/Desktop/HB/AbilityPanel"]
anchor_right = 1.0
anchor_bottom = 1.0
text = "0.0"
align = 2
valign = 2
